<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    /* CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
    body { font-family: "Prompt", sans-serif; background: #F0F6FF; color: #003B8E; margin: 0; padding: 20px; text-align: center; }
    .container { max-width: 420px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
    
    .tier-container { 
      background: #fff; 
      border: 1px solid #E1E8F5; 
      border-radius: 16px; 
      overflow: hidden; 
      margin-bottom: 25px; 
      text-align: left;
      box-shadow: 0 2px 10px rgba(0,0,0,0.02);
    }
    .tier-item { 
      padding: 15px 20px; 
      border-bottom: 1px solid #eee; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      font-size: 15px;
      color: #888;
      position: relative;
      transition: all 0.3s;
    }
    .tier-item:last-child { border-bottom: none; }
    
    .tier-item.active { 
      background: #E6F7FF; 
      color: #003B8E; 
      font-weight: 700; 
      border-left: 6px solid #0072FF;
    }
    .tier-item.sold-out { 
      background: #fcfcfc; 
      color: #ccc; 
    }
    .tier-item.sold-out span:first-child { text-decoration: line-through; }
    .tier-item.future { opacity: 0.6; }

    .badge-stock { 
      background: linear-gradient(135deg, #FF4D4F, #FF7875); 
      color: white; font-size: 12px; padding: 4px 10px; border-radius: 20px; margin-left: 8px; font-weight: 600;
      text-decoration: none !important; display: inline-block; vertical-align: middle;
      box-shadow: 0 2px 5px rgba(255, 77, 79, 0.4); animation: pulse 2s infinite;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .badge-sold {
      background: #999; color: white; font-size: 11px; padding: 3px 8px; border-radius: 4px; margin-left: 8px;
      text-decoration: none !important; display: inline-block; font-weight: 500;
    }

    .price-box { 
      background: linear-gradient(135deg, #00C6FF, #0072FF); 
      color: white; padding: 25px 20px; border-radius: 16px; margin-bottom: 25px; margin-top: 15px; 
      box-shadow: 0 8px 20px rgba(0,114,255,0.25); position: relative; overflow: hidden;
    }
    .price-box::after {
      content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 60%); pointer-events: none;
    }
    .price-label { font-size: 16px; opacity: 0.95; margin-bottom: 5px; font-weight: 300; }
    .price-val { font-size: 48px; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.15); line-height: 1; }
    .price-unit { font-size: 18px; font-weight: 400; opacity: 0.9; margin-left: 5px; }
    
    .qr-frame { 
      border: 3px solid #E1E8F5; border-radius: 20px; padding: 15px; display: inline-block; margin-bottom: 20px; 
      background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.08); position: relative;
    }
    .qr-frame::before {
      content: "SCAN ME"; position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
      background: #003B8E; color: white; padding: 2px 12px; border-radius: 10px; font-size: 12px; font-weight: bold; letter-spacing: 1px;
    }
    .qr-img { width: 100%; max-width: 260px; border-radius: 12px; display: block; }
    
    .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; margin-top: 15px; }
    .btn-select { 
      border: 2px dashed #0072FF; color: #0072FF; background-color: #F0F9FF; padding: 15px 20px; 
      border-radius: 12px; font-weight: 600; width: 100%; cursor: pointer; transition: 0.2s; font-size: 16px;
    }
    .btn-select:hover { background: #E6F7FF; border-color: #0056b3; }
    .upload-btn-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%; }
    
    #preview { margin-top: 20px; max-width: 100%; border-radius: 12px; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #eee; }
    
    .confirm-btn { 
      background: linear-gradient(90deg, #00C6FF, #0072FF); color: white; border: none; padding: 16px; 
      width: 100%; border-radius: 50px; font-size: 18px; font-weight: bold; margin-top: 25px; 
      cursor: pointer; display: none; box-shadow: 0 8px 25px rgba(0,114,255,0.3); transition: transform 0.2s;
    }
    .confirm-btn:active { transform: scale(0.98); }
    .confirm-btn:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }
    
    @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.85; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }
    
    #loading { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:99; flex-direction:column; justify-content:center; align-items:center; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #0072FF; border-radius: 50%; width: 45px; height: 45px; animation: spin 0.8s linear infinite; margin-bottom: 15px;}
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loading"><div class="spinner"></div><p style="color:#003B8E; font-weight:600;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</p></div>

  <div class="container">
    <h3 style="margin-top:0; color:#003B8E; font-size: 22px;">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏£‡πå‡∏™</h3>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤ (Pricing Tiers) -->
    <div class="tier-container" id="pricing-tiers">
      <div class="tier-item" id="tier-super">
        <span>Super Early Bird</span>
        <span id="price-super">...</span>
      </div>
      <div class="tier-item" id="tier-early">
        <span>Early Bird</span>
        <span id="price-early">...</span>
      </div>
      <div class="tier-item" id="tier-normal">
        <span>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥</span>
        <span id="price-normal">...</span>
      </div>
    </div>

    <div class="price-box">
      <div class="price-label">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)</div>
      <div>
        <span class="price-val" id="showPrice">...</span>
        <span class="price-unit">‡∏ö‡∏≤‡∏ó</span>
      </div>
    </div>

    <div class="qr-frame">
      <img src="https://lh5.googleusercontent.com/d/1XTK-hRKadNaPH5HUqgROer_xbuehWIT1" class="qr-img" id="qrImage">
      <p style="font-size: 13px; margin: 10px 0 0; color:#555; font-weight: 500;">
        <i class="fas fa-university"></i> ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢<br>
        <span style="color:#003B8E; font-weight:bold;">726-2-87971-7</span>
      </p>
    </div>

    <div style="text-align: left; margin-top: 15px;">
      <label style="font-weight: bold; font-size:15px; margin-left:5px; color:#333;">‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
      <div class="upload-btn-wrapper">
        <button class="btn-select" id="btnSelect">
          <i class="fas fa-cloud-upload-alt"></i> ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ
        </button>
        <input type="file" id="slipFile" accept="image/*" onchange="previewFile()">
      </div>
      <img id="preview">
    </div>

    <button class="confirm-btn" id="btnConfirm" onclick="uploadSlip()">
      <i class="fas fa-check-circle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
    </button>
  </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbycI4S8F3f82NZUZmPuShmPHM5csX2VN_QiCIbDEB080AYv7K8gOqWEdqBHmMRqWfboig/exec";

    const params = new URLSearchParams(window.location.search);
    const rowid = params.get('rowid');
    const userPrice = params.get('price'); 
    
    window.onload = function() {
      // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á Alert ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô
      if (!rowid || rowid === "undefined" || rowid === "null") {
        // ‡∏•‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤ rowid ‡∏à‡∏≤‡∏Å URL ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ URL ‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô)
        const urlStr = window.location.href;
        const match = urlStr.match(/rowid=([^&]+)/);
        if(!match) {
            alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (RowID Missing)\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô");
            window.location.href = WEB_APP_URL.split('?')[0] + "?page=index";
            return;
        }
      }

      fetch(WEB_APP_URL + "?action=getConfig")
        .then(res => res.json())
        .then(updatePricingUI)
        .catch(err => console.error("Load config error:", err));
    };

    function updatePricingUI(data) {
      if (!data) return;
      const paid = data.paidCount;
      const cfg = data.config; 

      document.getElementById('price-super').innerText = cfg.priceSuper.toLocaleString() + ".-";
      document.getElementById('price-early').innerText = cfg.priceEarly.toLocaleString() + ".-";
      document.getElementById('price-normal').innerText = cfg.priceNormal.toLocaleString() + ".-";

      const tSuper = document.getElementById('tier-super');
      const tEarly = document.getElementById('tier-early');
      const tNormal = document.getElementById('tier-normal');
      
      [tSuper, tEarly, tNormal].forEach(el => el.className = 'tier-item future');

      if (paid < cfg.superLimit) {
        tSuper.className = 'tier-item active';
        const left = cfg.superLimit - paid;
        tSuper.querySelector('span:first-child').innerHTML += ` <span class="badge-stock">üî• ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${left} ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</span>`;
      } else if (paid < (cfg.earlyLimit)) { 
        tSuper.className = 'tier-item sold-out';
        tSuper.querySelector('span:first-child').innerHTML += ` <span class="badge-sold">SOLD OUT</span>`;
        tEarly.className = 'tier-item active';
        const left = (cfg.earlyLimit) - paid;
        tEarly.querySelector('span:first-child').innerHTML += ` <span class="badge-stock">üî• ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${left} ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</span>`;
      } else {
        tSuper.className = 'tier-item sold-out';
        tSuper.querySelector('span:first-child').innerHTML += ` <span class="badge-sold">SOLD OUT</span>`;
        tEarly.className = 'tier-item sold-out';
        tEarly.querySelector('span:first-child').innerHTML += ` <span class="badge-sold">SOLD OUT</span>`;
        tNormal.className = 'tier-item active';
      }

      if (userPrice && userPrice !== "undefined") {
        document.getElementById('showPrice').innerText = Number(userPrice).toLocaleString();
      } else {
        document.getElementById('showPrice').innerText = "...";
      }
    }

    function previewFile() {
      const file = document.getElementById('slipFile').files[0];
      const preview = document.getElementById('preview');
      const btn = document.getElementById('btnConfirm');
      const btnSelect = document.getElementById('btnSelect');
      
      const reader = new FileReader();
      reader.onloadend = function() {
        preview.src = reader.result;
        preview.style.display = "block";
        btnSelect.innerHTML = '<i class="fas fa-sync-alt"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ';
        btnSelect.style.borderColor = "#ccc";
        btnSelect.style.color = "#888";
        btn.style.display = "block";
        btn.scrollIntoView({behavior: "smooth"});
      }
      if (file) reader.readAsDataURL(file);
    }

    function uploadSlip() {
      const file = document.getElementById('slipFile').files[0];
      if(!file) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ");

      const btn = document.getElementById('btnConfirm');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';
      btn.style.background = "#999";
      document.getElementById('loading').style.display = 'flex';

      const reader = new FileReader();
      reader.onload = function(e) {
        const base64 = e.target.result.split(',')[1];
        
        // ‡πÉ‡∏ä‡πâ rowid ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å params ‡∏´‡∏£‡∏∑‡∏≠ match
        let finalRowId = rowid;
        if (!finalRowId || finalRowId === "undefined") {
             const match = window.location.href.match(/rowid=([^&]+)/);
             if(match) finalRowId = match[1];
        }

        fetch(WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify({ 
            action: 'uploadSlip', 
            rowid: finalRowId, 
            base64: base64 
          })
        })
        .then(res => res.json())
        .then(res => {
          if(res.status === 'success') {
            // ‡∏•‡πâ‡∏≤‡∏á URL ‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Success
            let cleanUrl = WEB_APP_URL.split('?')[0];
            window.location.href = cleanUrl + "?page=success";
          } else {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + res.message);
            document.getElementById('loading').style.display = 'none';
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check-circle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô';
            btn.style.background = "linear-gradient(90deg, #00C6FF, #0072FF)";
          }
        })
        .catch(err => {
          document.getElementById('loading').style.display = 'none';
          alert("Connection Error: " + err.message);
          btn.disabled = false;
        });
      };
      reader.readAsDataURL(file);
    }
  </script>
</body>
</html>
